<html>
  <head> </head>
  <body>
    <div id="container" >
      <h1>Thumby Tree</h1>
    <div style="margin: 10px; float:left;">
      <div id="canvas"></div>
      <button
        id="startOver"
        style="margin: 10px; float:left;"
        class="waves-effect waves-light btn">
        Start Over
      </button>
    </div>
      
      <div id="questions" style="margin: 10px;">
        <h5>
          Identify your animal!
        </h3>
        <p id="milk">
          Does your animal produce milk?
        </p>
        <p id="feathers" hidden>
          Does your animal have feathers?
        </p>
        <p id="fins" hidden>
          Does your animal have fins?
        </p>
        <p id="backbone" hidden>
          Does your animal have a backbone?
        </p>
        <p id="legs" hidden>
          Does your animal have less than 6 legs?
        </p>
        <p id="breathes" hidden>
          Does your animal breathe?
        </p>
        <p id="venomous" hidden>
          Is your animal venomous?
        </p>
        <p id="toothed" hidden>
          Is your animal toothed?
        </p>
        <p id="type-1" hidden>
          Your animal is type 1.
        </p>
        <p id="type-2" hidden>
          Your animal is type 2.
        </p>
        <p id="type-3" hidden>
          Your animal is type 3.
        </p>
        <p id="type-4" hidden>
          Your animal is type 4.
        </p>
        <p id="type-5" hidden>
          Your animal is type 5.
        </p>
        <p id="type-6" hidden>
          Your animal is type 6.
        </p>
        <p id="type-7" hidden>
          Your animal is type 7.
        </p>
      </div>
      
    </div>
  </body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
<!-- Compiled and minified CSS -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
/>

<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script type="text/javascript">
  // Classifier Variable
  let classifier;
  // Model URL
  let imageModelURL =
    "https://teachablemachine.withgoogle.com/models/KZs7UsTcR/";

  // Video
  let video;
  let flippedVideo;
  // To store the classification
  let label = "";

  // define an initial confidence
  var confidence = 0;
  var mean_confidence = 0;

  // Load the model first
  function preload() {
    classifier = ml5.imageClassifier(imageModelURL + "model.json");
  }

  function setup() {
    let cnv = createCanvas(320, 240);
    cnv.parent("canvas");
    // Create the video
    video = createCapture(VIDEO);
    video.size(320, 240);
    video.hide();

    flippedVideo = ml5.flipImage(video);
    // Start classifying
    classifyVideo();
  }

  function draw() {
    background(0);
    // Draw the video
    image(flippedVideo, 0, 0);

    /* Draw the label
    fill("white");
    textSize(16);
    textAlign(CENTER);
    text(display_text, width / 2, height - 4);
    */
  }

  $("#startOver").click(startOver);

  function startOver() {
    $("#milk").html("Does your animal produce milk?");
    $("p").hide();
    $("#milk").show();
    step = 1;
    confidence_counter = 1;
    cumulative_confidence = 0;
    mean_confidence = 0;
  }

  // this gets the video

  // classify it, we want to wait so the user can change the hand
  function classifyVideo() {
    classifier.classify(flippedVideo, gotResult);
    flippedVideo.remove();
  }
  var step = 1;
  var last_question = "";
  var last_shown = "";
  // the confidence accumulates the average confidence over a > 1 predictions so the model is more confident and also takes
  // longer so the user has time to move her hand. to count the number of predictions, we use a confidence counter.
  var confidence_counter = 1;
  // the confidence counter and the confidence need to be reset after displaying making a transition in the user message
  // When we get a result

  var cumulative_confidence = 0;

  function gotResult(error, results) {
    // If there is an error
    if (error) {
      console.error(error);
      return;
    }
    // The results are in an array ordered by confidence.
    // console.log(results[0]);
    label = results[0].label;
    if (label == "Class 1") {
      label = "Yes";
    } else {
      label = "No";
    }
    cumulative_confidence = results[0].confidence + cumulative_confidence;
    mean_confidence = cumulative_confidence / confidence_counter;
    console.log(mean_confidence);
    console.log(results[0].confidence);
    console.log(confidence_counter);
    // Classifiy again!
    flippedVideo = ml5.flipImage(video);
    classifyVideo();
    confidence_counter++;

    if (confidence_counter == 80) {
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
    }

    // if it has milk, its type 1
    if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 1 &&
      confidence_counter > 40
    ) {
      $("#milk").after("<p>" + label + "<p>");
      $("#type-1").show();
      last_shown = "#type-1";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 1 &&
      confidence_counter > 40
    ) {
      $("#milk").after("<p>" + label + "<p>");

      $("#feathers").show();
      last_shown = "#feathers";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step++;
      // if it has feathers, its type 2
    } else if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 2 &&
      confidence_counter > 40
    ) {
      $("#feathers").after("<p>" + label + "<p>");
      $("#type-2").show();
      last_shown = "#type-2";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 2 &&
      confidence_counter > 40
    ) {
      // if it doesnt have feathers, ask if it has fins
      $("#feathers").after("<p>" + label + "<p>");
      $("#fins").show();
      last_shown = "#fins";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step++;
    } else if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 3 &&
      confidence_counter > 40
    ) {
      // if it has fins, is a type 4
      $("#fins").after("<p>" + label + "<p>");
      $("#type-4").show();
      last_shown = "#type-4";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 3 &&
      confidence_counter > 40
    ) {
      // if it doesnt have a fin, ask about the backbone
      $("#fins").after("<p>" + label + "<p>");
      $("#backbone").show();
      last_shown = "#backbone";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step++;
    } else if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 4 &&
      confidence_counter > 40
    ) {
      // if it has a backbone, ask about venom
      $("#backbone").after("<p>" + label + "<p>");
      $("#venomous").show();
      last_question = "venomous";
      last_shown = "#venomous";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step++;
      // if it doesnt have venom, ask about toothed
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 5 &&
      last_question == "venomous" &&
      confidence_counter > 40
    ) {
      $("#venomous").after("<p>" + label + "<p>");
      $("#toothed").show();
      last_question = "toothed";
      last_shown = "#toothed";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step++;
      //if its toothed, its type 5
    } else if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 6 &&
      last_question == "toothed" &&
      confidence_counter > 40
    ) {
      $("#toothed").after("<p>" + label + "<p>");
      $("#type-5").show();
      last_shown = "#type-5";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
      //if its not toothed, its type 3
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 6 &&
      last_question == "toothed" &&
      confidence_counter > 40
    ) {
      $("#toothed").after("<p>" + label + "<p>");
      $("#type-3").show();
      last_shown = "#type-3";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
      // if it has venom, its type 3
    } else if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 5 &&
      last_question == "venomous" &&
      confidence_counter > 40
    ) {
      $("#venomous").after("<p>" + label + "<p>");
      $("#type-3").show();
      last_shown = "#type-3";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
      // if it doesnt have a backbone, ask about legs
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 4 &&
      confidence_counter > 40
    ) {
      $("#backbone").after("<p>" + label + "<p>");
      $("#legs").show();
      last_question = "legs";
      last_shown = "#legs";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step++;
      // if it has less than 6 legs, its type 7
    } else if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 5 &&
      last_question == "legs" &&
      confidence_counter > 40
    ) {
      $("#legs").after("<p>" + label + "<p>");
      $("#type-7").show();
      last_shown = "#type-7";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
      // if it doesnt have less than 6 legs, ask about breathes
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 5 &&
      last_question == "legs" &&
      confidence_counter > 40
    ) {
      $("#legs").after("<p>" + label + "<p>");
      $("#breathes").show();
      last_question = "breathes";
      last_shown = "#breathes";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step++;
      // if it doesnt breathe, its type 7
    } else if (
      mean_confidence > 0.9 &&
      label == "Yes" &&
      step == 6 &&
      last_question == "breathes" &&
      confidence_counter > 40
    ) {
      $("#breathes").after("<p>" + label + "<p>");
      $("#type-7").show();
      last_shown = "#type-7";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
      // if it breathes, its type 6
    } else if (
      mean_confidence > 0.9 &&
      label == "No" &&
      step == 6 &&
      last_question == "breathes" &&
      confidence_counter > 40
    ) {
      $("#breathes").after("<p>" + label + "<p>");
      $("#type-6").show();
      last_shown = "#type-6";
      confidence_counter = 1;
      cumulative_confidence = 0;
      mean_confidence = 0;
      step = -1;
    }
  }
</script>
